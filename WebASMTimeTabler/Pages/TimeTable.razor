@page "/timetable"
@using WebASMTimeTabler.Core
@using CoreDay = WebASMTimeTabler.Core.DayOfWeek
@inject ScheduleStateService StateService

<PageTitle>시간표</PageTitle>


<div class="d-flex gap-4">
    <div class="card p-3 flex-shrink-0" style="width: 300px;">
        <h5>필터 설정</h5>
        
        <h6>실시간 필터 (Realtime)</h6>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="useLunchBreak">
            <label class="form-check-label">점심시간 공강 (12:00-13:00)</label>
        </div>

        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="useMorningFilter">
            <label class="form-check-label">아침수업 금지 (10시 이전)</label>
        </div>

        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="useNoFriday">
            <label class="form-check-label">금요일 공강</label>
        </div>

        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="useMaxConsecutive">
            <label class="form-check-label">연강 제한 (최대 @maxConsecutiveHours 시간)</label>
        </div>
        <div class="ms-3 mb-2" style="display: @(useMaxConsecutive ? "block" : "none")">
            <input type="number" class="form-control form-control-sm" @bind="maxConsecutiveHours" min="1" max="10" />
        </div>

        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="useBreakTimeFilter">
            <label class="form-check-label">특정 시간대 공강</label>
        </div>
        <div class="ms-3 mb-2 row" style="display: @(useBreakTimeFilter ? "flex" : "none")">
            <div class="col-4">
                <select class="form-select form-select-sm" @bind="breakTimeDay">
                    @foreach (var day in Enum.GetValues<CoreDay>().Take(5))
                    {
                        <option value="@day">@DaysOfWeek[(int)day]</option>
                    }
                </select>
            </div>
            <div class="col-4">
                <input type="number" class="form-control form-control-sm" @bind="breakTimeStartHour" min="0" max="23" />
            </div>
            <div class="col-4">
                <input type="number" class="form-control form-control-sm" @bind="breakTimeEndHour" min="1" max="24" />
            </div>
            <small class="text-muted mt-1">@(DaysOfWeek[(int)breakTimeDay]) @breakTimeStartHour 시 ~ @breakTimeEndHour 시</small>
        </div>

        <hr/>
        
        <h6>최종 필터 (Final)</h6>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="useIdleTimeFilter">
            <label class="form-check-label">유휴시간 최소화 (최대 @maxIdleHours 시간)</label>
        </div>
        <div class="ms-3 mb-2" style="display: @(useIdleTimeFilter ? "block" : "none")">
            <input type="number" class="form-control form-control-sm" @bind="maxIdleHours" min="1" max="5" />
        </div>

        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="useMaxDailyCourses">
            <label class="form-check-label">하루 최대 수업 수 (@maxCoursesPerDay 개)</label>
        </div>
        <div class="ms-3 mb-2" style="display: @(useMaxDailyCourses ? "block" : "none")">
            <input type="number" class="form-control form-control-sm" @bind="maxCoursesPerDay" min="1" max="10" />
        </div>

        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="useTotalCreditFilter">
            <label class="form-check-label">총 학점 제한 (@minCredit ~ @maxCredit 학점)</label>
        </div>
        <div class="ms-3 mb-2 row" style="display: @(useTotalCreditFilter ? "flex" : "none")">
            <div class="col-6">
                <input type="number" class="form-control form-control-sm" @bind="minCredit" min="0" />
            </div>
            <div class="col-6">
                <input type="number" class="form-control form-control-sm" @bind="maxCredit" min="@minCredit" />
            </div>
        </div>

        <button class="btn btn-primary mt-3" @onclick="GenerateSchedules">시간표 생성</button>
    </div>
    <!-- 우측: 시간표 결과 패널 -->
    <div class="flex-grow-1">
        @if (generatedSchedules.Count == 0 && loading)
        {
            <p><em>시간표 생성 중...</em></p>
        }
        else if (generatedSchedules.Count == 0 && !loading)
        {
            <p><em>조건에 맞는 시간표가 없습니다.</em></p>
        }
        else
        {
        @foreach (var (schedule, idx) in generatedSchedules.Select((s, i) => (s, i + 1)))
            {
                <div class="card my-3 p-3">
                    <h5>시간표 @idx</h5>
                    <table class="table table-bordered text-center align-middle" style="width: 100%; table-layout: fixed;">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px;">시간</th>
                                @foreach (var day in DaysOfWeek)
                                {
                                    <th>@day</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @for (int hour = StartHour; hour <= EndHour; hour++)
                            {
                                <tr>
                                    @{
                                        // hour=1은 9:00, hour가 1 증가하면 30분 증가
                                        // 9:00 + (hour - 1) * 30분
                                        var totalMinutes = 9 * 60 + (hour - 1) * 30;
                                        var displayHour = totalMinutes / 60;
                                        var displayMinute = totalMinutes % 60;
                                        
                                        // 9:00, 9:30, 10:00, ... 형식으로 표시
                                        <span>@($"{displayHour:D2}:{displayMinute:D2}")</span>
                                    }
                                    @foreach (var day in DaysOfWeek)
                                    {
                                        // 1. 현재 hour에 시작하는 수업이 있는지 확인
                                        var courseSlot = schedule
                                            .SelectMany(c => c.Times.Select(t => (Course: c, Time: t)))
                                            .FirstOrDefault(x => x.Time.day.ToString() == day && x.Time.start == hour);

                                        if (courseSlot.Course != null)
                                        {
                                            // 1-A. 수업이 시작하는 셀을 rowspan과 함께 렌더링
                                            var color = GetCourseColor(courseSlot.Course.Name);
                                            <td rowspan="@(courseSlot.Time.end - courseSlot.Time.start + 1)" 
                                                style="background-color:@color; color:white; font-weight:bold;">
                                                @courseSlot.Course.Name <br />
                                                <small>@courseSlot.Course.Professor</small>
                                            </td>
                                        }
                                        // 2. 현재 hour가 이미 렌더링된 rowspan 셀에 포함되어 있는지 확인
                                        else if (schedule.SelectMany(c => c.Times)
                                                         .Any(t => t.day.ToString() == day && t.start < hour && t.end >= hour))
                                        {
                                            // 2-A. 이미 위에서 렌더링된 셀에 포함되었으므로, 현재 <td>는 렌더링하지 않음
                                            // 아무것도 출력하지 않고 이 루프를 건너뜁니다.
                                        }
                                        else
                                        {
                                            // 3. 수업도 없고 rowspan에 포함되지 않은 완전히 빈 셀을 렌더링
                                            <td></td>
                                        }
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
    </div>
</div>


@code {
    private List<List<Course>> generatedSchedules = new();

    private static readonly string[] DaysOfWeek = { "월", "화", "수", "목", "금", "토" };
    private const int StartHour = 1;
    private const int EndHour = 23;
    private bool loading = false;
    
    // 필터 바인딩 변수
    // Realtime Filters
    private bool useLunchBreak = false;
    private bool useMorningFilter = false;
    private bool useNoFriday = false;
    private bool useMaxConsecutive = false;
    private int maxConsecutiveHours = 5; // MaxConsecutiveFilter 기본값

    private bool useBreakTimeFilter = false;
    private CoreDay breakTimeDay = CoreDay.월; // BreakTimeFilter 기본 요일 (월)
    private int breakTimeStartHour = 7; // BreakTimeFilter 기본 시작 시간 (점심시간 12:00에 해당하는 시간 인덱스)
    private int breakTimeEndHour = 9;   // BreakTimeFilter 기본 종료 시간 (점심시간 13:00에 해당하는 시간 인덱스)

    // Final Filters
    private bool useIdleTimeFilter = false;
    private int maxIdleHours = 2; // IdleTimeFilter 기본값
    
    private bool useMaxDailyCourses = false;
    private int maxCoursesPerDay = 3; // MaxDailyCoursesFilter 기본값

    private bool useTotalCreditFilter = false;
    private int minCredit = 0;
    private int maxCredit = 18; // TotalCreditFilter 기본값

    // 랜덤 색상 저장용
    private Dictionary<string, string> courseColors = new();

    private string GetCourseColor(string courseName)
    {
        if (!courseColors.ContainsKey(courseName))
        {
            var rand = new Random(courseName.GetHashCode());
            var hue = rand.Next(0, 360);
            courseColors[courseName] = $"hsl({hue}, 70%, 50%)"; // 예쁜 파스텔 톤
        }
        return courseColors[courseName];
    }
    private async Task GenerateSchedules()
    {
        loading = true;
        generatedSchedules.Clear();
        StateHasChanged(); // "생성 중..." 메시지를 즉시 표시하기 위해 호출

        var selectedCourses = StateService.SelectedCourses.ToList();
        // 필터 목록 구성
        var realtimeFilters = new List<IRealtimeFilter> { new TimeConflictFilter() }; // 시간 충돌은 항상 적용
        var finalFilters = new List<IFinalFilter>();
        
        if (useLunchBreak) realtimeFilters.Add(new LunchBreakFilter());
        if (useMorningFilter) realtimeFilters.Add(new MorningFilter());
        if (useNoFriday) realtimeFilters.Add(new NoDayFilter(CoreDay.금));
        
        if (useMaxConsecutive) realtimeFilters.Add(new MaxConsecutiveFilter(maxConsecutiveHours));
        if (useBreakTimeFilter) realtimeFilters.Add(new BreakTimeFilter(breakTimeDay, (breakTimeStartHour, breakTimeEndHour)));

        if (useIdleTimeFilter) finalFilters.Add(new IdleTimeFilter(maxIdleHours));
        if (useMaxDailyCourses) finalFilters.Add(new MaxDailyCoursesFilter(maxCoursesPerDay));
        if (useTotalCreditFilter) finalFilters.Add(new TotalCreditFilter(minCredit, maxCredit));


        var service = new ScheduleService(
            maxPages: 50,
            realtimeFilters: realtimeFilters,
            finalFilters: finalFilters
        );

        // IAsyncEnumerable을 직접 순회합니다.
        await foreach (var schedule in service.GenerateSchedulesAsync(selectedCourses))
        {
            generatedSchedules.Add(schedule);
            StateHasChanged(); // 결과가 나올 때마다 UI를 갱신

            // ✅ 핵심: UI 스레드에 제어권을 잠시 넘겨줘서 멈춤 현상을 방지합니다.
            await Task.Delay(1);
        }

        // 모든 작업이 끝난 후 loading 상태를 변경합니다.
        //Console.WriteLine($"총 {generatedSchedules.Count}개의 시간표 생성됨."); // deguging
        loading = false;
        StateHasChanged();
    }
}